# WebSocket 再接続問題の修正

## 概要

2026 年 2 月 6 日に立花証券 e 支店から、 WebSocket 接続が 2378 回発生したとの連絡があった。
原因を調査し、タイムアウト設定を修正する。

## 問題

### 現象
- 2 月 6 日に WebSocket 接続が 2378 回発生
- 本来は常時接続で 1 日 1-2 回の接続で済むはず

### 原因
`client/event.go:217` で設定されている読み取りタイムアウトが **5 秒** と短すぎる：

```go
_ = conn.SetReadDeadline(time.Now().Add(5 * time.Second))
```

サーバーは約 5 秒間隔で KP（keepalive）を送信するが、わずかなタイミングのずれで
タイムアウトが発生し、再接続が繰り返される。

### 調査結果（demo 環境）
- サーバー KP 間隔: **5 秒ごと**
- サーバー PING: **約 25 秒ごと**
- WebSocket ping/pong: サポートされている（応答に遅延あり）

## 解決策

### 対象コンポーネント
- **tachibanashi** ライブラリ（`client/event.go`）

### 変更内容
読み取りタイムアウトを **5 秒 → 60 秒** に延長する。

```go
// Before
_ = conn.SetReadDeadline(time.Now().Add(5 * time.Second))

// After
_ = conn.SetReadDeadline(time.Now().Add(60 * time.Second))
```

### 理由
- サーバーが 5 秒ごとに KP を送信するため、 60 秒あれば 12 回分の余裕がある
- ネットワーク遅延や一時的な問題があっても、即座に再接続しない
- シンプルな変更で副作用が少ない

### 検討したが採用しなかった案
1. **クライアント ping/pong 追加**: サーバーが pong を返すが遅延があり不安定。複雑さに見合わない
2. **スケジュールベース接続管理**: 電話認証が必要なため手動対応が発生し現実的でない

## 影響範囲

### ポジティブ
- 不要な再接続が大幅に削減される（理論上 1 時間あたり最大 1 回に）
- サーバー負荷軽減
- データ欠損リスク低減

### ネガティブ
- 本当の接続断の検知が最大 60 秒遅れる
  - 許容範囲: サーバー KP が 5 秒ごとに来るため、通常は 5 秒以内に次のデータが届く

## タスク

1. [ ] `client/event.go` のタイムアウト定数を追加・変更
2. [ ] 変更をコミット
3. [ ] data-collector の go.mod を更新して新バージョンを参照

## テスト

- demo 環境で接続し、 60 秒間データがなくても再接続しないことを確認
- KP 受信が継続することを確認
